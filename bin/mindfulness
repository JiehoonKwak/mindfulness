#!/usr/bin/env bash
set -e

PROJECT_DIR="$HOME/DevHub/sideprojects/mindfulness"
FE_PORT="${MINDFULNESS_FE_PORT:-3141}"
BE_PORT="${MINDFULNESS_BE_PORT:-8141}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[mindfulness]${NC} $1"; }
warn() { echo -e "${YELLOW}[mindfulness]${NC} $1"; }
err() { echo -e "${RED}[mindfulness]${NC} $1" >&2; }

usage() {
  cat <<EOF
Usage: mindfulness <command> [target]

Commands:
  start [fe|be|all]   Start servers (default: all)
  stop                Stop all servers
  restart [fe|be|all] Restart servers
  status              Check if running
  open                Open app in browser
  install             Install all dependencies
  build               Build frontend for production
  test                Run backend tests
  logs [fe|be]        Tail server logs

Ports:
  Frontend: $FE_PORT (http://localhost:$FE_PORT)
  Backend:  $BE_PORT (http://localhost:$BE_PORT)

Environment Variables:
  MINDFULNESS_FE_PORT   Frontend port (default: 3141)
  MINDFULNESS_BE_PORT   Backend port (default: 8141)
EOF
}

graceful_kill() {
  local port=$1
  local name=$2
  local pids

  if pids=$(lsof -ti :$port 2>/dev/null); then
    echo "$pids" | xargs kill -TERM 2>/dev/null || true
    for i in 1 2 3; do
      sleep 1
      if ! lsof -ti :$port >/dev/null 2>&1; then
        log "$name stopped"
        return 0
      fi
    done
    if pids=$(lsof -ti :$port 2>/dev/null); then
      echo "$pids" | xargs kill -9 2>/dev/null || true
      log "$name force-stopped"
    fi
  else
    log "$name not running"
  fi
}

start_server() {
  local target="${1:-all}"

  case "$target" in
  frontend | fe)
    if lsof -ti :$FE_PORT >/dev/null 2>&1; then
      log "Frontend already running on port $FE_PORT"
    else
      cd "$PROJECT_DIR/frontend"
      bun run dev &
      log "Frontend starting on port $FE_PORT..."
      sleep 2
    fi
    ;;
  backend | be)
    if lsof -ti :$BE_PORT >/dev/null 2>&1; then
      log "Backend already running on port $BE_PORT"
    else
      cd "$PROJECT_DIR/backend"
      uv run uvicorn app.main:app --reload --host 0.0.0.0 --port "$BE_PORT" &
      log "Backend starting on port $BE_PORT..."
      sleep 2
    fi
    ;;
  all)
    start_server frontend
    start_server backend
    echo ""
    log "Frontend: http://localhost:$FE_PORT"
    log "Backend:  http://localhost:$BE_PORT"
    ;;
  *)
    err "Unknown target: $target"
    exit 1
    ;;
  esac
}

stop_server() {
  log "Stopping servers..."
  graceful_kill $FE_PORT "Frontend"
  graceful_kill $BE_PORT "Backend"
}

check_status() {
  echo "Mindfulness App Status:"
  echo ""
  if lsof -ti :$FE_PORT >/dev/null 2>&1; then
    echo "  Frontend: RUNNING (port $FE_PORT)"
  else
    echo "  Frontend: STOPPED"
  fi
  if lsof -ti :$BE_PORT >/dev/null 2>&1; then
    echo "  Backend:  RUNNING (port $BE_PORT)"
  else
    echo "  Backend:  STOPPED"
  fi
  echo ""
  echo "  Database: $PROJECT_DIR/backend/data/mindfulness.db"
}

open_app() {
  if ! lsof -ti :$FE_PORT >/dev/null 2>&1; then
    log "App not running. Starting..."
    start_server all
    sleep 2
  fi
  open "http://localhost:$FE_PORT"
}

case "${1:-}" in
start)
  start_server "${2:-all}"
  ;;
stop)
  stop_server
  ;;
restart)
  stop_server
  sleep 1
  start_server "${2:-all}"
  ;;
status)
  check_status
  ;;
open)
  open_app
  ;;
install)
  log "Installing frontend dependencies..."
  cd "$PROJECT_DIR/frontend" && bun install
  log "Installing backend dependencies..."
  cd "$PROJECT_DIR/backend" && uv sync
  log "Done"
  ;;
build)
  log "Building frontend..."
  cd "$PROJECT_DIR/frontend" && bun run build
  log "Build complete: $PROJECT_DIR/frontend/dist/"
  ;;
test)
  log "Running backend tests..."
  cd "$PROJECT_DIR/backend" && uv run pytest -v
  ;;
logs)
  target="${2:-all}"
  case "$target" in
  fe | frontend)
    lsof -ti :$FE_PORT >/dev/null 2>&1 && log "Tailing frontend (Ctrl+C to exit)..." || err "Frontend not running"
    ;;
  be | backend)
    lsof -ti :$BE_PORT >/dev/null 2>&1 && log "Tailing backend (Ctrl+C to exit)..." || err "Backend not running"
    ;;
  *)
    check_status
    ;;
  esac
  ;;
*)
  usage
  ;;
esac
